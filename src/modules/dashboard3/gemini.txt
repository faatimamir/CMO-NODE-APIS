// import { GoogleGenAI } from "@google/genai";
// const ai = new GoogleGenAI({});
// const GEMINI_API_KEY = process.env.GOOGLE_API_KEY;
// const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });
// const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY as string);
// const groundingTool = {
//   googleSearch: {},
// };


// import { GoogleGenerativeAI, Tool, GoogleSearch } from '@google/generative-ai';
// import { GoogleGenAI, FunctionCallingConfigMode, Tool ,DynamicRetrievalConfigMode} from '@google/genai';


// const config = {
//   tools: [groundingTool],
// };
// export async function fetchCompetitorsFromLLM(
//   site: any,
//   userRequirement: any,
//   competitorsToGenerate: number = 5,
//   existingUrls: string[] = [],
//   existingNames: string[] = []
// ): Promise<string> {
//   if (competitorsToGenerate !== 5) {
//     console.warn("competitorsToGenerate should be 5 to match the prompt's request for exactly 5 competitors.");
//     competitorsToGenerate = 5;
//   }

//   const prompt = `
// You are an expert market research assistant specializing in competitor analysis. Your task is to identify **exactly 5 unique, famous, market-leading competitors** for the given main website, ranked in order of prominence (most renowned and established first). The competitors must be:

//  - **Real, active, well-known businesses** with operational websites that return an HTTP 200 status.
//  - **Market leaders or top-tier** in the same industry.
//  - Highly relevant to the main website's industry and region.
//  - Targeting a similar audience.
//  - Offering distinct but related products/services with a clear USP.
//  - Not included in: ${existingUrls.join(', ') || 'none'} (URLs), ${existingNames.join(', ') || 'none'} (names).
//  - Not social media, generic platforms, or marketplaces.
//  - Diverse in offerings or regional focus.
//  - Each must include a valid, accessible **homepage URL** (e.g., https://example.com).

//  **Main Website Metadata**:
//  - Website URL: ${site.website_url ?? 'Unknown'}
//  - Title: ${site.page_title ?? 'None'}
//  - Description: ${site.meta_description ?? 'None'}
//  - Keywords: ${site.meta_keywords ?? 'None'}

//  **User Requirements**:
//  - Industry: ${userRequirement.industry ?? 'Unknown'}
//  - Region of Operation: ${userRequirement.region_of_operation ?? 'Unknown'}
//  - Target Location: ${userRequirement.target_location ?? 'Unknown'}
//  - Target Audience: ${userRequirement.target_audience ?? 'Unknown'}
//  - Primary Offering: ${userRequirement.primary_offering ?? 'Unknown'}
//  - USP: ${userRequirement.USP ?? 'Unknown'}

//  **Output Format**:
//  Return a valid **JSON array** of exactly 5 competitors, ordered by prominence (most famous first). Each must contain:

//  - "name": Company name (e.g., "Nike")
//  - "website_url": Homepage URL (e.g., "https://www.nike.com")
//  - "industry": Specific industry (e.g., "Athletic Apparel")
//  - "primary_offering": Main product/service (e.g., "Sportswear and footwear")
//  - "usp": Unique selling proposition (e.g., "High-performance athletic gear worn by top athletes")
//  - "logo_url": Favicon or logo URL (e.g., "https://www.nike.com/favicon.ico")

//  Do **not** wrap the JSON in markdown code blocks.
//  If no valid competitors are found, return an empty array: [].


// **Example Output for Apple Inc.**:
//  [
//    {
//      "name": "Samsung",
//      "website_url": "https://www.samsung.com",
//      "industry": "Consumer Electronics",
//      "primary_offering": "Smartphones, tablets, and electronics",
//      "usp": "Innovative Android devices with diverse price points",
//    },
//    {
//      "name": "Google",
//      "website_url": "https://store.google.com",
//      "industry": "Consumer Electronics",
//      "primary_offering": "Pixel phones and smart devices",
//      "usp": "Android-powered devices with Google ecosystem integration",
//    },
//    {
//      "name": "Microsoft",
//      "website_url": "https://www.microsoft.com",
//      "industry": "Technology",
//      "primary_offering": "Surface laptops and tablets",
//      "usp": "Productivity-focused devices for business and personal use",

//    },
//    {
//      "name": "Dell",
//      "website_url": "https://www.dell.com",
//      "industry": "Computer Hardware",
//      "primary_offering": "Laptops and desktops",
//      "usp": "Customizable PCs for personal and business users",
//    },
//    {
//      "name": "Lenovo",
//      "website_url": "https://www.lenovo.com",
//      "industry": "Computer Hardware",
//      "primary_offering": "Laptops, desktops, tablets",
//      "usp": "Wide range of devices with competitive pricing"
// `;

//   try {
    

//     const response = await ai.models.generateContent({
//     model: 'gemini-2.5-flash',
//     contents: prompt,
//     config,
//   });

//     const output = response.text;

//     if (!output) {
//       console.warn(`Gemini returned empty response for website_url: ${site.website_url}`);
//       return '[]';
//     }

//     let cleaned = output
//       .replace(/```json\n?|```/g, '')
//       .replace(/,\s*([\]}])/g, '$1')
//       .trim();

//     if (!cleaned.startsWith('[') || !cleaned.endsWith(']')) {
//       if (cleaned.startsWith('{') && cleaned.endsWith('}')) {
//           cleaned = `[${cleaned}]`;
//       } else {
//           console.error(`Gemini returned non-JSON array format for website_url: ${site.website_url}: ${output}`);
//           return '[]';
//       }
//     }

//     let competitors: any[];
//     try {
//       competitors = JSON.parse(cleaned);
//     } catch (parseErr) {
//       const errMsg = parseErr instanceof Error ? parseErr.message : String(parseErr);
//       console.error(`Gemini returned invalid JSON for website_url: ${site.website_url}: ${errMsg}`);
//       console.error(`Raw output: ${output}`);
//       return '[]';
//     }

//     const validCompetitors = competitors.filter(comp =>
//       comp.name &&
//       comp.website_url &&
//       comp.website_url.startsWith('http') &&
//       !existingUrls.includes(comp.website_url) &&
//       !existingNames.includes(comp.name)
//     );

//     return JSON.stringify(validCompetitors.slice(0, competitorsToGenerate));
//   } catch (err: any) {
//     console.error(`Error fetching competitors from Gemini for website_url: ${site.website_url}: ${err.message}`);
//     return '[]';
//   }
// }